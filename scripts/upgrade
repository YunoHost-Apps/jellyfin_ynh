#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

if ynh_app_upgrading_from_version_before 10.10.7~ynh1; then
    ynh_die "Your installation is to old to update to this version. \
        \nPlease first manually update with 10.10.7~ynh2 with the following command: \
        \n's\0u\0d\0o yunohost app upgrade $app -u https://github.com/YunoHost-Apps/jellyfin_ynh/commit/be23267b55c6f2c2caeb23566357d0564fe2f914' \
        \nOnce done you can upgrade to the latest version."
fi


#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="$app" --action="stop" --log_path="systemd" --timeout=15

if ynh_app_upgrading_from_version_before 10.11.6~ynh2; then

    mkdir -p $install_dir/config
    mkdir -p $install_dir/cache

    cp -rf /var/www/jellyfin/* "$data_dir"
	cp -rf /etc/$app/* "$install_dir/config"
    cp -rf /var/cache/$app/* "$install_dir/cache"

    ynh_safe_rm "/etc/$app/"
    ynh_safe_rm "/etc/default/jellyfin"
    ynh_safe_rm "/etc/systemd/system/jellyfin.service.d"
    ynh_safe_rm "/etc/sudoers.d/jellyfin-sudoers"
    ynh_safe_rm "/var/lib/$app"
    ynh_safe_rm "/var/cache/$app"

	ynh_safe_rm "/var/www/jellyfin/data"
	ynh_safe_rm "/var/www/jellyfin/metadata"
	ynh_safe_rm "/var/www/jellyfin/plugins"
	ynh_safe_rm "/var/www/jellyfin/root"
	ynh_safe_rm "/var/www/jellyfin/'Subtitle Edit'"

    config_path="$install_dir/config"
    log_path="/var/log/$app"
    cache_path="$install_dir/cache"
    ynh_app_setting_set --key=config_path --value="$config_path"

	ynh_replace --match="<EncoderAppPathDisplay>/usr/lib/jellyfin-ffmpeg/ffmpeg</EncoderAppPathDisplay>" \
	            --replace="<EncoderAppPathDisplay>$install_dir/ffmpeg/ffmpeg</EncoderAppPathDisplay>" \
	            --file="$install_dir/config/encoding.xml"

	chown -R $app:$app "$data_dir"
	chown -R $app:$app "$install_dir"

	# Remove old systemd config
	ynh_config_remove_systemd
fi

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

# If render group exists, and system user doesn't belong to it, add it
if getent group render && ! id -Gn "$app" | grep -qw "\brender\b" >/dev/null; then
	adduser "$app" render
fi

ynh_app_setting_delete --key=is_public

if [ ! -f "/etc/logrotate.d/$app" ]; then
	# Fix possibly missing file due to buggy restore:
	ynh_config_add_logrotate
fi

if ynh_app_upgrading_from_version_before 10.11.5~ynh1
then
	# Create UserDatas table before the migration // Thanks to https://github.com/getumbrel/umbrel-apps/pull/3872/changes/502e93dd57bd34e2899edb9ffd5dac1a7dbcbb89
	sqlite3 "$data_dir/data/library.db" "
	BEGIN TRANSACTION;
	CREATE TABLE IF NOT EXISTS UserDatas (
    	key TEXT NOT NULL,
    	userId TEXT NOT NULL,
    	rating REAL,
    	played INTEGER NOT NULL,
    	playCount INTEGER NOT NULL,
    	isFavorite INTEGER NOT NULL,
    	playbackPositionTicks INTEGER NOT NULL,
    	lastPlayedDate TEXT,
    	AudioStreamIndex INTEGER,
    	SubtitleStreamIndex INTEGER,
    	PRIMARY KEY (key, userId)
	);
	COMMIT;
	"
fi

#=================================================
# REMOVE OLD FILES
#=================================================
# Remove $data_dir/plugins-backup to mitigate a failed upgrade because a plugin is already there since an old upgrade (see below).
# If it’s still there, it’s likely that the admin didn’t use this version of the plugin anymore.
ynh_script_progression "Removing $data_dir/plugins-backup directory..."
ynh_safe_rm "$data_dir/plugins-backup"

#=================================================
# ENSURE NO OLD/INCOMPATIBLE PLUGINS ARE LEFT
#=================================================
shopt -s nullglob
mkdir -p $data_dir/plugins-backup

if [ -d $data_dir/plugins ]; then
	for directory in $data_dir/plugins/*; do
		name="$(basename "$directory")"
		if [[ "$name" = "configurations" ]]; then
			# Keep plugin config
			continue
		fi

		if [ ! -f "$directory"/meta.json ]; then
			ynh_print_warn "Jellyfin plugin '$name' looks legacy (missing meta.json). Moving to $data_dir/plugins-backup."
			mv "$directory" $data_dir/plugins-backup/
		fi

		# Jellyfin doesn't refuse to start with old plugins. It just does weird
		# things such as https://github.com/jellyfin/jellyfin-plugin-ldapauth/issues/161
		# As a precaution, move older ABI plugins to another folder so things don't break
		abi="$(jq -r '.targetAbi' "$directory/meta.json")"

		if dpkg --compare-versions "$abi" lt "$plugin_abi"; then
			ynh_print_warn "Jellyfin plugin '$name' ABI $abi is lower than expected $plugin_abi. Moving to $data_dir/plugins-backup."
			mv "$directory" $data_dir/plugins-backup/
		fi
	done
fi

#=================================================
# INSTALL LDAP PLUGIN
#=================================================
ynh_script_progression "Installing LDAP plugin..."

ynh_setup_source --dest_dir="$data_dir/plugins/LDAP Authentication" --source_id=plugin_ldap --full_replace

mkdir -p $data_dir/plugins/configurations/
ynh_config_add --template="LDAP-Auth.xml" --destination="$data_dir/plugins/configurations/LDAP-Auth.xml"

chown -R "$app:" "$data_dir"

#=================================================
# UPGRADE PACKAGES
#=================================================
ynh_script_progression "Upgrading source files..."

# Backup the configuration files to prevent yunohost to see a manual edit
bakdir=$(mktemp -d)
for name in system.xml network.xml logging.json; do
	cp "$config_path/$name" "$bakdir/$name"
done

upgrade_jellyfin_packages

#=================================================
# UPDATE A CONFIG FILE
#=================================================
ynh_script_progression "Updating configuration..."

# Restore the files we just backed up before installing the debs...
for name in system.xml network.xml logging.json; do
	mv -f "$bakdir/$name" "$config_path/$name"
done
ynh_safe_rm "$bakdir"

ynh_config_add --template=".env" --destination="$install_dir/.env"
ynh_config_add --template="network.xml" --destination="$config_path/network.xml"
ynh_config_add --template="logging.json" --destination="$config_path/logging.json"

#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================

# Set permissions on app files
chown -R "$app:" "$data_dir"
chown -R "$app:" "$install_dir"

#=================================================
# YUNOHOST MULTIMEDIA INTEGRATION
#=================================================
ynh_script_progression "Adding multimedia directories..."

# Build YunoHost multimedia directories
ynh_multimedia_build_main_dir

# Allow Jellyfin to write into these directories
ynh_multimedia_addaccess "$app"

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_script_progression "Setting up systemd..."

# Create a dedicated systemd config
ynh_config_add_systemd

yunohost service add "${app}" --description="Jellyfin media center" --log="/var/log/${app}/${app}.log"

#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

# Create a dedicated NGINX config
ynh_config_add_nginx

# Use logrotate to manage app-specific logfile(s)
ynh_config_add_logrotate

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service="$app" --action="start" --timeout=15

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
